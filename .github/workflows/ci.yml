name: CI

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

jobs:
  validate-pr:
    name: validate-pr
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Validate PR Title
        run: |
          title="${{ github.event.pull_request.title }}"
          if ! echo "$title" | grep -qE '^(feat|fix|docs|style|refactor|perf|test|chore|ci|build|revert): .{10,}$'; then
            echo "❌ PR title does not meet requirements"
            echo "Expected format: <type>: <description (min 10 chars)>"
            echo "Allowed types: feat, fix, docs, style, refactor, perf, test, chore, ci, build, revert"
            echo "Your title: $title"
            exit 1
          fi
          echo "✅ PR title is valid"

      - name: Validate PR Description
        run: |
          body="${{ github.event.pull_request.body }}"
          word_count=$(echo "$body" | wc -w)
          if [ "$word_count" -lt 15 ]; then
            echo "❌ PR description is too short (found $word_count words, minimum 15 required)"
            echo "Please provide a meaningful description that explains:"
            echo "  - What problem does this PR solve?"
            echo "  - How did you solve it?"
            echo "  - Any relevant context or testing notes?"
            exit 1
          fi
          echo "✅ PR description is sufficient ($word_count words)"

      - name: Validate Branch Name
        run: |
          branch="${{ github.head_ref }}"
          if ! echo "$branch" | grep -qE '^(feature|fix|docs)/[a-z0-9-]+$'; then
            echo "❌ Branch name does not follow convention"
            echo "Expected format: feature/*, fix/*, or docs/*"
            echo "Your branch: $branch"
            exit 1
          fi
          echo "✅ Branch name is valid"

  lint-imports:
    name: lint-imports
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Lint absolute imports
        shell: bash
        run: |
          set -euo pipefail
          pattern="^[[:space:]]*(import|export)[^;]*from[[:space:]]+['\"]src/|^[[:space:]]*import[[:space:]]+['\"]src/"
          if command -v rg >/dev/null 2>&1; then
            matches=$(rg -n \
              --glob '!**/node_modules/**' \
              --glob '!**/dist/**' \
              --glob '!**/build/**' \
              --glob '!**/.next/**' \
              --glob '!**/coverage/**' \
              --glob '!**/out/**' \
              --glob '!**/tmp/**' \
              --glob '!**/.turbo/**' \
              --glob '!**/.cache/**' \
              --glob '*.ts' \
              --glob '*.tsx' \
              "$pattern" . || true)
          else
            matches=$(grep -RIn \
              --include='*.ts' \
              --include='*.tsx' \
              --exclude-dir=node_modules \
              --exclude-dir=dist \
              --exclude-dir=build \
              --exclude-dir=.next \
              --exclude-dir=coverage \
              --exclude-dir=out \
              --exclude-dir=tmp \
              --exclude-dir=.turbo \
              --exclude-dir=.cache \
              -E "$pattern" . || true)
          fi
          if [ -n "$matches" ]; then
            echo "ERROR: Absolute imports from \"src/\" are not allowed. Use relative paths instead."
            echo "$matches"
            exit 1
          fi

  build:
    name: build
    needs: validate-pr
    if: always() && (needs.validate-pr.result == 'success' || needs.validate-pr.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: npm
      - name: Install dependencies
        run: npm ci
      - name: Build frontend
        run: npm --workspace frontend run build
      - name: Build backend
        run: npm --workspace backend run build

  type-check:
    name: type-check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm
      - name: Install dependencies
        run: npm ci
      - name: Type-check frontend
        run: npm --workspace frontend exec -- tsc --noEmit -p tsconfig.json
      - name: Type-check backend
        run: npm --workspace backend exec -- tsc --noEmit -p tsconfig.json
